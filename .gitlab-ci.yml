image: docker:stable

services:
  - docker:dind

before_script:
  - apk update && apk add git
  - wget https://github.com/earthly/earthly/releases/download/v0.6.12/earthly-linux-amd64 -O /usr/local/bin/earthly
  - chmod +x /usr/local/bin/earthly
  - export FORCE_COLOR=1
  - /usr/local/bin/earthly bootstrap
  - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  - git config --global url."https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/".insteadOf "git@gitlab.com:"
  - git submodule sync --recursive
  - git submodule update --init --recursive

stages:
  - container

container:
  stage: container
  variables:
    CONTAINER_IMAGE: $CI_REGISTRY_IMAGE/ckan:$CI_COMMIT_BRANCH-$CI_COMMIT_SHA
  script:
    - earthly --ci --push --build-arg CONTAINER_IMAGE=$CONTAINER_IMAGE +container
