# https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#using-docker-caching

image: docker:stable

services:
  - docker:dind

variables:
  CONTAINER_IMAGE: registry.gitlab.com/$CI_PROJECT_PATH/$CI_COMMIT_REF_NAME
  DOCKER_HOST: tcp://docker:2375
  DOCKER_DRIVER: overlay2
  GIT_SUBMODULE_STRATEGY: recursive
  TARGET: deploy-gitlab

before_script:
  - apk update
  - apk add python3 make wget
  - pip3 install fades

docker:
  script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
    - make
    - cd output/$TARGET
    - docker pull $CONTAINER_IMAGE:latest || true
    - docker build --cache-from $CONTAINER_IMAGE:latest --tag $CONTAINER_IMAGE:$CI_COMMIT_SHA --tag $CONTAINER_IMAGE:latest .
    - docker pull $CONTAINER_IMAGE/solr:latest || true
    - docker build --cache-from $CONTAINER_IMAGE/solr:latest --tag $CONTAINER_IMAGE/solr:$CI_COMMIT_SHA --tag $CONTAINER_IMAGE/solr:latest solr
    - fades -d docker-compose -x docker-compose up --detach
    - wget --spider --recursive --no-directories --no-verbose --wait 0.1 --retry-connrefused --waitretry 10 --tries 12 --level 1 docker:5000
    - fades -d docker-compose -x docker-compose down --volumes
    - docker push $CONTAINER_IMAGE:$CI_COMMIT_SHA
    - docker push $CONTAINER_IMAGE:latest
    - docker push $CONTAINER_IMAGE/solr:$CI_COMMIT_SHA
    - docker push $CONTAINER_IMAGE/solr:latest
  artifacts:
    paths:
      - output/deploy/docker-compose.yml
